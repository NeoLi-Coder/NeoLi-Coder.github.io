import{at as C,j as l,au as T,av as p,ak as h,aw as c,l as g,e as E,ar as m,as as S,am as u,ax as L,ac as w,ay as A,az as b,i as D,aA as $}from"./vidstack-4c4227d4-5daa9c9e.js";import{VideoProvider as _}from"./vidstack-video-1406c788.js";import{R as I}from"./vidstack-2604ee68-b23b31d9.js";import"./app-58c204aa.js";const R=o=>$(o);class V{constructor(t){this.Ca=null,this.Tf=null,this.y={},this.z=new Set,this.Q=t}get instance(){return this.Ca}setup(t,i){this.Sf=i;const e=p(i.$state.streamType).includes("live"),r=p(i.$state.streamType).includes("ll-");this.Ca=new t({lowLatencyMode:r,backBufferLength:r?4:e?8:void 0,renderTextTracksNatively:!1,...this.y});const s=this.Uf.bind(this);for(const a of Object.values(t.Events))this.Ca.on(a,s);this.Ca.on(t.Events.ERROR,this.fd.bind(this));for(const a of this.z)a(this.Ca);i.player.dispatch(new h("hls-instance",{detail:this.Ca})),this.Ca.attachMedia(this.Q),this.Ca.on(t.Events.AUDIO_TRACK_SWITCHED,this.Vf.bind(this)),this.Ca.on(t.Events.LEVEL_SWITCHED,this.Wf.bind(this)),this.Ca.on(t.Events.LEVEL_LOADED,this.Xf.bind(this)),this.Ca.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Yf.bind(this)),this.Ca.on(t.Events.CUES_PARSED,this.Zf.bind(this)),i.qualities[c.hb]=this._f.bind(this),g(i.qualities,"change",this.$f.bind(this)),g(i.audioTracks,"change",this.ag.bind(this)),this.Tf=E(this.bg.bind(this))}bg(){if(!this.Sf.$state.live())return;const t=new I(this.cg.bind(this));return t.Ub(),t.Vb.bind(t)}cg(){var t;this.Sf.$state.liveSyncPosition.set(((t=this.Ca)==null?void 0:t.liveSyncPosition)??1/0)}Uf(t,i){var e;(e=this.Sf.player)==null||e.dispatch(new h(R(t),{detail:i}))}Yf(t,i){const e=new h(t,{detail:i});let r=-1;for(let s=0;s<i.tracks.length;s++){const a=i.tracks[s],n=a.subtitleTrack??a.closedCaptions,f=new m({id:`hls-${a.kind}${s}`,src:n==null?void 0:n.url,label:a.label,language:n==null?void 0:n.lang,kind:a.kind});f[S.Ga]=2,f[S.Va]=()=>{f.mode==="showing"?(this.Ca.subtitleTrack=s,r=s):r===s&&(this.Ca.subtitleTrack=-1,r=-1)},a.default&&f.setMode("showing",e),this.Sf.textTracks.add(f,e)}}Zf(t,i){const e=this.Sf.textTracks.getById(`hls-${i.track}`);if(!e)return;const r=new h(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,r)}Vf(t,i){const e=this.Sf.audioTracks[i.id];e&&this.Sf.audioTracks[u.Y](e,!0,new h(t,{detail:i}))}Wf(t,i){const e=this.Sf.qualities[i.level];e&&this.Sf.qualities[u.Y](e,!0,new h(t,{detail:i}))}Xf(t,i){if(this.Sf.$state.canPlay())return;const{type:e,live:r,totalduration:s,targetduration:a}=i.details,n=new h(t,{detail:i});this.Sf.delegate.A("stream-type-change",{detail:r?e==="EVENT"&&Number.isFinite(s)&&a>=10?"live:dvr":"live":"on-demand",trigger:n}),this.Sf.delegate.A("duration-change",{detail:s,trigger:n});const f=this.Ca.media;this.Ca.currentLevel===-1&&this.Sf.qualities[c.gb](!0,n);for(const d of this.Ca.audioTracks)this.Sf.audioTracks[u.h]({id:d.id+"",label:d.name,language:d.lang||"",kind:"main"},n);for(const d of this.Ca.levels)this.Sf.qualities[u.h]({width:d.width,height:d.height,codec:d.codecSet,bitrate:d.bitrate},n);f.dispatchEvent(new h("canplay",{trigger:n}))}fd(t,i){var e,r,s;if(i.fatal)switch(i.type){case"networkError":(e=this.Ca)==null||e.startLoad();break;case"mediaError":(r=this.Ca)==null||r.recoverMediaError();break;default:(s=this.Ca)==null||s.destroy(),this.Ca=null;break}}_f(){this.Ca&&(this.Ca.currentLevel=-1)}$f(){const{qualities:t}=this.Sf;!this.Ca||t.auto||(this.Ca[t.switch+"Level"]=t.selectedIndex,L&&(this.Q.currentTime=this.Q.currentTime))}ag(){const{audioTracks:t}=this.Sf;this.Ca&&this.Ca.audioTrack!==t.selectedIndex&&(this.Ca.audioTrack=t.selectedIndex)}D(){var t,i;this.Sf&&(this.Sf.qualities[c.hb]=void 0),(t=this.Ca)==null||t.destroy(),this.Ca=null,(i=this.Tf)==null||i.call(this),this.Tf=null}}class H{constructor(t,i,e){this.pf=t,this.Sf=i,this.fg=e,this.dg()}async dg(){const t={onLoadStart:this.Af.bind(this),onLoaded:this.Jf.bind(this),onLoadError:this.eg.bind(this)};let i=await q(this.pf,t);if(w(i)&&!l(this.pf)&&(i=await O(this.pf,t)),!i)return null;if(!i.isSupported()){const e="[vidstack]: `hls.js` is not supported in this environment";return this.Sf.player.dispatch(new h("hls-unsupported")),this.Sf.delegate.A("error",{detail:{message:e,code:4}}),null}return i}Af(){this.Sf.player.dispatch(new h("hls-lib-load-start"))}Jf(t){this.Sf.player.dispatch(new h("hls-lib-loaded",{detail:t})),this.fg(t)}eg(t){const i=A(t);this.Sf.player.dispatch(new h("hls-lib-load-error",{detail:i})),this.Sf.delegate.A("error",{detail:{message:i.message,code:4}})}}async function O(o,t={}){var i,e,r,s,a;if(!w(o)){if((i=t.onLoadStart)==null||i.call(t),o.prototype&&o.prototype!==Function)return(e=t.onLoaded)==null||e.call(t,o),o;try{const n=(r=await o())==null?void 0:r.default;if(n&&n.isSupported)(s=t.onLoaded)==null||s.call(t,n);else throw Error("");return n}catch(n){(a=t.onLoadError)==null||a.call(t,n)}}}async function q(o,t={}){var i,e,r;if(l(o)){(i=t.onLoadStart)==null||i.call(t);try{if(await b(o),!D(window.Hls))throw Error("");const s=window.Hls;return(e=t.onLoaded)==null||e.call(t,s),s}catch(s){(r=t.onLoadError)==null||r.call(t,s)}}}const N="https://cdn.jsdelivr.net",v=class v extends _{constructor(){super(...arguments),this.$$PROVIDER_TYPE="HLS",this.x=null,this.v=new V(this.video),this.w=`${N}/npm/hls.js@^1.0.0/dist/hls.min.js`}get ctor(){return this.x}get instance(){return this.v.instance}get type(){return"hls"}get canLiveSync(){return!0}get config(){return this.v.y}set config(t){this.v.y=t}get library(){return this.w}set library(t){this.w=t}preconnect(){l(this.w)&&T(this.w)}setup(t){super.setup(t),new H(this.w,t,i=>{this.x=i,this.v.setup(i,t),t.delegate.A("provider-setup",{detail:this});const e=p(t.$state.source);e&&this.loadSource(e)})}async loadSource(t,i){var e;l(t.src)&&(this.B.preload=i||"",(e=this.v.instance)==null||e.loadSource(t.src),this.C=t)}onInstance(t){const i=this.v.instance;return i&&t(i),this.v.z.add(t),()=>this.v.z.delete(t)}destroy(){this.v.D()}};v.supported=C();let y=v;export{y as HLSProvider};
